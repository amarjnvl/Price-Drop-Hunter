# Architecture

> Auto-generated by /map on 2026-02-18

## Overview

Price Drop Hunter is a Python-based application designed to track product prices on Amazon and Flipkart. It integrates with Telegram for user interaction (adding products, receiving alerts) and uses Google Sheets as a persistent data store. The application can run in two modes: as a webhook-based Flask application (suitable for cloud deployment like Render) or as a standalone script (suitable for local use or GitHub Actions).

```
┌─────────────────────────────────────────┐
│        [Telegram User / Webhook]        │
├─────────────────────────────────────────┤
│            [Flask Application]          │
│         (main.py - Entry Point)         │
├─────────────────────────────────────────┤
│         [Business Logic Layer]          │
│      (Command Parsing, Scraping)        │
├─────────────────────────────────────────┤
│            [Data Layer]                 │
│      (Google Sheets via gspread)        │
└─────────────────────────────────────────┘
```

## Components

### Core Application
- **Purpose:** Entry point, web server, and command orchestration.
- **Location:** `main.py`
- **Dependencies:** `flask`, `requests`, `gspread`, `beautifulsoup4`, `dotenv`

### Scraper Module (Internal)
- **Purpose:** Extracts product details (title, price) from Amazon and Flipkart URLs.
- **Location:** `main.py` (functions `scrape_product_info`, `scrape_title`, `scrape_price`)
- **Strategies:**
    - JSON-LD Structured Data (Primary)
    - CSS Selectors (Platform specific)
    - Meta Tags (OG tags)
    - Regex / HTML Parsing (Fallback)

### Database Adapter (Internal)
- **Purpose:** Manages connection and CRUD operations with Google Sheets.
- **Location:** `main.py` (functions `connect_to_sheet`, `get_products_worksheet`, `log_price_history`)
- **Schema:**
    - **Products:** Name, URL, Target_Price, Current_Price, Last_Alerted, Status
    - **Settings:** Stores `last_update_id` for Telegram polling.
    - **Price_History:** Log of price checks.

### Telegram Handler (Internal)
- **Purpose:** Processes incoming updates from Telegram and sends notifications.
- **Location:** `main.py` (functions `get_telegram_updates`, `send_telegram_message`, `phase1_process_commands`)

## Data Flow

1. **Input:**
   - **Webhook Mode:** Telegram sends a POST request to the Flask app.
   - **Polling Mode:** Script queries Telegram `getUpdates` API.
2. **Processing:**
   - Command is parsed (e.g., `/add <url>`).
   - If a URL is found, `scrape_product_info` fetches the page.
   - Scraper attempts multiple extraction strategies to find price and title.
3. **Storage:**
   - Product data is written to the "Products" worksheet in Google Sheets.
   - Price history is logged to "Price_History".
4. **Output:**
   - Confirmation message or Price Drop Alert is sent back to the user via Telegram API.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| Telegram Bot API | REST API | User interface, command input, notifications |
| Google Sheets API | API | Persistent storage for watchlist and history |
| Amazon/Flipkart | HTTP/HTML | Source of product data (via scraping) |

## Technical Debt

- [ ] **Monolithic Structure:** All logic (scraping, database, web server, bot handling) is contained in a single `main.py` file.
- [ ] **Hardcoded Selectors:** CSS selectors for scraping are hardcoded and may break if target site layouts change.
- [ ] **Lack of Tests:** No automated tests (unit or integration) are evident.
- [ ] **Limited Error Handling:** Basic try/except blocks; robust retry logic for network flakes could be improved.
- [ ] **Sync/Blocking:** Scraping is synchronous; checking many products might time out in a webhook context.

## Conventions

**Naming:** Pythonic `snake_case` for functions and variables. Constants in `UPPER_CASE`.
**Structure:** Functional programming style within a single script.
**Logging:** Standard `logging` library used with timestamps.
